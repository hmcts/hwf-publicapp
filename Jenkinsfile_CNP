#!groovy

@Library("Infrastructure")

def type = "ruby"
def product = "help-with-fees"
def component = "publicapp"

def rubyBuilder = new uk.gov.hmcts.contino.RubyBuilder(this)
def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

withPipeline(type, product, component) {
  env.RAILS_ENV = 'test'
  env.RACK_ENV = 'test'
  env.TEST_BROWSER = 'chrome_local'
  env.NODE_OPTIONS='--openssl-legacy-provider'
  env.ENABLE_COVERAGE='true'
  // random free port should probably be used instead
  env.GOVUK_NOTIFY_API_KEY = 'mocked_in_tests'


  before('build') {
    sh script:"""#!/bin/bash -l
      set +x
      source /usr/local/rvm/scripts/rvm
      rvm install ruby-4.0.1
      rvm use ruby-4.0.1 --default
      """, label: 'Ruby version install'
  }

   before('test') {
      sh script:"yarn install", label: 'Start test'
      rubyBuilder.bundle("install")
      rubyBuilder.bundle("exec rails assets:precompile")

      sh script: 'docker run -d --name zap -p 8080:8080 ghcr.io/zaproxy/zaproxy zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.disablekey=true', label: 'Start ZAP'
      sh script: 'sleep 15', label: 'Wait for ZAP to start'
      env.DRIVER = 'firefox_zap'
  }

  afterAlways('test') {
      sh script: 'docker stop zap && docker rm zap || true', label: 'Stop ZAP'
  }
}


